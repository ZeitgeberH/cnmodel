
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cnmodel.util.pynrnutilities &#8212; CNModel 0.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CNModel 0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cnmodel.util.pynrnutilities</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1">#</span>
<span class="c1"># utilities for NEURON, in Python</span>
<span class="c1"># Module neuron for cnmodel</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span> <span class="c1"># masked array</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">collections</span>

<span class="kn">import</span> <span class="nn">neuron</span>


<span class="n">_mechtype_cache</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="all_mechanism_types"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.all_mechanism_types">[docs]</a><span class="k">def</span> <span class="nf">all_mechanism_types</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a dictionary of all available mechanism types.</span>
<span class="sd">    </span>
<span class="sd">    Each dictionary key is the name of a mechanism and each value is</span>
<span class="sd">    another dictionary containing information about the mechanism::</span>
<span class="sd">    </span>
<span class="sd">        mechanism_types = {</span>
<span class="sd">            &#39;mech_name1&#39;: {</span>
<span class="sd">                &#39;point_process&#39;: bool,</span>
<span class="sd">                &#39;artificial_cell&#39;: bool,</span>
<span class="sd">                &#39;netcon_target&#39;: bool,</span>
<span class="sd">                &#39;has_netevent&#39;: bool,</span>
<span class="sd">                &#39;internal_type&#39;: int,</span>
<span class="sd">                &#39;globals&#39;: {name:size, ...},</span>
<span class="sd">                &#39;parameters&#39;: {name:size, ...},</span>
<span class="sd">                &#39;assigned&#39;: {name:size, ...},</span>
<span class="sd">                &#39;state&#39;: {name:size, ...},</span>
<span class="sd">            },</span>
<span class="sd">            &#39;mech_name2&#39;: {...},</span>
<span class="sd">            &#39;mech_name3&#39;: {...},</span>
<span class="sd">            ...</span>
<span class="sd">        }</span>
<span class="sd">    </span>
<span class="sd">    * point_process: False for distributed mechanisms, True for point </span>
<span class="sd">        processes and artificial cells.</span>
<span class="sd">    * artificial_cell: True for artificial cells, False otherwise</span>
<span class="sd">    * netcon_target: True if the mechanism can receive NetCon events</span>
<span class="sd">    * has_netevent: True if the mechanism can emit NetCon events</span>
<span class="sd">    * internal_type: Integer specifying the NEURON internal type index of </span>
<span class="sd">        the mechanism</span>
<span class="sd">    * globals: dict of the name and vector size of the mechanism&#39;s global</span>
<span class="sd">        variables</span>
<span class="sd">    * parameters: dict of the name and vector size of the mechanism&#39;s </span>
<span class="sd">        parameter variables</span>
<span class="sd">    * assigned: dict of the name and vector size of the mechanism&#39;s </span>
<span class="sd">        assigned variables</span>
<span class="sd">    * state: dict of the name and vector size of the mechanism&#39;s state</span>
<span class="sd">        variables</span>


<span class="sd">    Note: The returned data structure is cached; do not modify it.</span>
<span class="sd">        </span>
<span class="sd">    For more information on global, parameter, assigned, and state </span>
<span class="sd">    variables see:</span>
<span class="sd">    http://www.neuron.yale.edu/neuron/static/docs/help/neuron/nmodl/nmodl.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_mechtype_cache</span>
    <span class="k">if</span> <span class="n">_mechtype_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_mechtype_cache</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">mname</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Iterate over two mechanism types (distributed, point/artificial)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">mt</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">MechanismType</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">nmech</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
            <span class="c1"># Iterate over all mechanisms of this type</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmech</span><span class="p">):</span>
                <span class="n">mt</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">mt</span><span class="o">.</span><span class="n">selected</span><span class="p">(</span><span class="n">mname</span><span class="p">)</span>
                
                <span class="c1"># General mechanism properties</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">mname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># convert hoc string ptr to python str</span>
                
                <span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;point_process&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                    <span class="s1">&#39;netcon_target&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">is_netcon_target</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span>
                    <span class="s1">&#39;has_netevent&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">has_net_event</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span>
                    <span class="s1">&#39;artificial_cell&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">is_artificial</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span>
                    <span class="s1">&#39;internal_type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">internal_type</span><span class="p">()),</span>
                <span class="p">}</span>
                
                <span class="c1"># Collect information about 4 different types of variables</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">ptype</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;globals&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">),</span> 
                                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;assigned&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)]:</span>
                    <span class="n">desc</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># collections.OrderedDict()</span>
                    <span class="n">ms</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">MechanismStandard</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">count</span><span class="p">())):</span>
                        <span class="n">psize</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="n">mname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># parameter name</span>
                        <span class="n">desc</span><span class="p">[</span><span class="n">ptype</span><span class="p">][</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">psize</span><span class="p">)</span>
                
                <span class="c1"># Assemble everything in one place</span>
                <span class="n">_mechtype_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
            
    <span class="k">return</span> <span class="n">_mechtype_cache</span></div>


<div class="viewcode-block" id="reset"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.reset">[docs]</a><span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">raiseError</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Introspect the NEURON kernel to verify that no objects are left over</span>
<span class="sd">    from previous simulation runs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Release objects held by an internal buffer</span>
    <span class="c1"># See https://www.neuron.yale.edu/phpBB/viewtopic.php?f=2&amp;t=3221</span>
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>    
    
    <span class="c1"># Make sure nothing is hanging around in an old exception or because of</span>
    <span class="c1"># reference cycles </span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exc_clear</span><span class="p">()</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">numsec</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">allsec</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">remaining</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;Section&#39;</span><span class="p">))</span>
        
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="s1">&#39;NetCon&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">remaining</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;NetCon&#39;</span><span class="p">))</span>
    
    <span class="c1"># No point processes or artificial cells left</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">all_mechanism_types</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">typ</span><span class="p">[</span><span class="s1">&#39;artificial_cell&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">typ</span><span class="p">[</span><span class="s1">&#39;point_process&#39;</span><span class="p">]:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">remaining</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raiseError</span><span class="p">:</span>  <span class="c1"># note that not raising the error leads to memory leak</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot reset--old objects have not been cleared: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
               <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rem</span> <span class="k">for</span> <span class="n">rem</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="custom_init"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.custom_init">[docs]</a><span class="k">def</span> <span class="nf">custom_init</span><span class="p">(</span><span class="n">v_init</span><span class="o">=-</span><span class="mf">60.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a custom initialization of the current model/section. </span>
<span class="sd">    </span>
<span class="sd">    This initialization follows the scheme outlined in the</span>
<span class="sd">    NEURON book, 8.4.2, p 197 for initializing to steady state.</span>
<span class="sd">    </span>
<span class="sd">    N.B.: For a complex model with dendrites/axons and different channels,</span>
<span class="sd">    this initialization will not find the steady-state the whole cell,</span>
<span class="sd">    leading to initial transient currents. In that case, this initialization</span>
<span class="sd">    should be followed with a 0.1-5 second run (depends on the rates in the</span>
<span class="sd">    various channel mechanisms) with no current injection or active point</span>
<span class="sd">    processes to allow the system to settle to a steady- state. Use either</span>
<span class="sd">    h.svstate or h.batch_save to save states and restore them. Batch is</span>
<span class="sd">    preferred</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v_init : float (default: -60 mV)</span>
<span class="sd">        Voltage to start the initialization process. This should</span>
<span class="sd">        be close to the expected resting state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inittime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e10</span>
    <span class="n">tdt</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span>  <span class="c1"># save current step size</span>
    <span class="n">dtstep</span> <span class="o">=</span> <span class="mf">1e9</span>
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">(</span><span class="n">v_init</span><span class="p">)</span> 
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">inittime</span>  <span class="c1"># set time to large negative value (avoid activating</span>
                    <span class="c1"># point processes, we hope)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">cvode</span><span class="o">.</span><span class="n">active</span><span class="p">()</span>  <span class="c1"># check state of variable step integrator</span>
    <span class="k">if</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># turn off CVode variable step integrator if it was active</span>
        <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">cvode</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># now just use backward Euler with large step</span>
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dtstep</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e9</span><span class="p">:</span>  <span class="c1"># Step forward</span>
        <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">fadvance</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1">#print(&#39;advances: &#39;, n)</span>
    <span class="k">if</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">cvode</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># restore integrator</span>
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">cvode</span><span class="o">.</span><span class="n">active</span><span class="p">():</span>
        <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">cvode</span><span class="o">.</span><span class="n">re_init</span><span class="p">()</span>  <span class="c1"># update d(state)/dt and currents</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">fcurrent</span><span class="p">()</span>  <span class="c1"># recalculate currents</span>
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">frecord_init</span><span class="p">()</span>  <span class="c1"># save new state variables</span>
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">tdt</span>  <span class="c1"># restore original time step</span></div>
        

<span class="c1"># routine to convert conductances from nS as given elsewhere</span>
<span class="c1">#   to mho/cm2 as required by NEURON 1/28/99 P. Manis</span>
<span class="c1"># units: nano siemens, soma area in um^2</span>
<span class="c1">#</span>
<div class="viewcode-block" id="nstomho"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.nstomho">[docs]</a><span class="k">def</span> <span class="nf">nstomho</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">somaarea</span><span class="p">,</span> <span class="n">refarea</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">refarea</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1E-9</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">somaarea</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1e9</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">refarea</span><span class="p">)</span></div>

<div class="viewcode-block" id="mho2ns"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.mho2ns">[docs]</a><span class="k">def</span> <span class="nf">mho2ns</span><span class="p">(</span><span class="n">mho</span><span class="p">,</span> <span class="n">somaarea</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mho</span><span class="p">)</span><span class="o">*</span><span class="n">somaarea</span><span class="o">/</span><span class="mf">1E-9</span></div>

<div class="viewcode-block" id="spherearea"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.spherearea">[docs]</a><span class="k">def</span> <span class="nf">spherearea</span><span class="p">(</span><span class="n">dia</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    given diameter in microns, return sphere area in cm2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">dia</span><span class="o">*</span><span class="mf">1e-4</span> <span class="c1"># convert to cm</span>
    <span class="k">return</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_sections"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.get_sections">[docs]</a><span class="k">def</span> <span class="nf">get_sections</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    go through all the sections and find the names of the sections and all of their</span>
<span class="sd">    parts (ids). Returns a dict, of sec: [id0, id1...]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">secnames</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">resec</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;(\w+)\[(\d*)\]&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">allsec</span><span class="p">():</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">resec</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sec</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">secnames</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">secnames</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">secnames</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">secnames</span></div>

<div class="viewcode-block" id="all_objects"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.all_objects">[docs]</a><span class="k">def</span> <span class="nf">all_objects</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Return a dict of all objects known to NEURON. </span>
<span class="sd">    </span>
<span class="sd">    Keys are &#39;Section&#39;, &#39;Segment&#39;, &#39;Mechanism&#39;, &#39;Vector&#39;, &#39;PointProcess&#39;, </span>
<span class="sd">    &#39;NetCon&#39;, ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;Section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">all_sec</span><span class="p">())</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;Segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;Section&#39;</span><span class="p">]:</span>
        <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;Segment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sec</span><span class="o">.</span><span class="n">allseg</span><span class="p">()))</span>
    <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;PointProcess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;Segment&#39;</span><span class="p">]:</span>
        <span class="n">objs</span><span class="p">[</span><span class="s1">&#39;PointProcess&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">point_processes</span><span class="p">()))</span>
        
    <span class="k">return</span> <span class="n">objs</span></div>
    


<div class="viewcode-block" id="alpha"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.alpha">[docs]</a><span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">amp</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">tdur</span> <span class="o">=</span> <span class="mf">50.</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.010</span><span class="p">):</span>
    <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tdur</span> <span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">aw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tvec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tvec</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">delay</span><span class="p">:</span>
            <span class="n">aw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">delay</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">delay</span><span class="p">)</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span> <span class="c1"># alpha waveform time course</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">aw</span><span class="p">,</span> <span class="n">tvec</span><span class="p">)</span></div>

<div class="viewcode-block" id="syns"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.syns">[docs]</a><span class="k">def</span> <span class="nf">syns</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">amp</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.020</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mindur</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="n">makewave</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;	Calculate a poisson train of alpha waves</span>
<span class="sd">    with mean rate rate, with a delay and duration (in mseco) dt in msec.</span>
<span class="sd">    N specifies the number of such independent waveforms to sum &quot;&quot;&quot;</span>
    <span class="n">deadtime</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="k">if</span> <span class="n">dur</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">&lt;</span> <span class="n">mindur</span><span class="p">:</span>
        <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">mindur</span> <span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dur</span><span class="o">+</span><span class="n">delay</span> <span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
    <span class="n">ta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">aw</span> <span class="o">=</span> <span class="n">ta</span> <span class="o">*</span> <span class="n">alpha</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ta</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="n">alpha</span> <span class="c1"># alpha waveform time course</span>
    <span class="n">spt</span> <span class="o">=</span> <span class="p">[[]]</span><span class="o">*</span><span class="n">N</span> <span class="c1"># list of spike times</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="c1"># waveform</span>
    <span class="n">sptime</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">t</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">nsp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">delay</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">delay</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">delay</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">delay</span><span class="o">+</span><span class="n">dur</span><span class="p">):</span>
                <span class="n">ti</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rate</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">)</span> <span class="c1"># convert to exponential distribution with rate</span>
                <span class="k">if</span> <span class="n">ti</span> <span class="o">&lt;</span> <span class="n">deadtime</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">ti</span> <span class="c1"># running time</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">delay</span><span class="o">+</span><span class="n">dur</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">nsp</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sptime</span> <span class="o">=</span> <span class="n">t</span>
                <span class="n">nsp</span> <span class="o">=</span> <span class="n">nsp</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sptime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sptime</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">nsp</span> <span class="o">=</span> <span class="n">nsp</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wavej</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tvec</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sptime</span><span class="p">)):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sptime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">wavej</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavej</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">spt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sptime</span>

        <span class="k">if</span> <span class="n">makewave</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">wavej</span><span class="p">,</span> <span class="n">aw</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">aw</span><span class="p">))</span><span class="o">*</span><span class="n">amp</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">npts</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">npts</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npts</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">wave</span> <span class="o">=</span> <span class="n">w</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wave</span> <span class="o">=</span> <span class="n">wave</span> <span class="o">+</span> <span class="n">w</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">spt</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span></div>


<div class="viewcode-block" id="an_syn"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.an_syn">[docs]</a><span class="k">def</span> <span class="nf">an_syn</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">spont</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">driven</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
           <span class="n">amp</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.020</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">makewave</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># constants for AN:</span>
    <span class="n">deadtime</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="c1"># min time between spikes, msec</span>
    <span class="n">trise</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1"># rise rate, ms</span>
    <span class="n">tfall</span> <span class="o">=</span>  <span class="mf">0.5</span> <span class="c1"># fall rate, ms</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">driven</span><span class="o">/</span><span class="mf">1000.0</span> <span class="c1"># spikes/millisecond</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">rss</span> <span class="c1"># transient driven rate</span>
    <span class="n">rst</span> <span class="o">=</span> <span class="n">rss</span>
    <span class="n">taur</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># rapid decay, msec</span>
    <span class="n">taust</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">ton</span> <span class="o">=</span> <span class="n">delay</span> <span class="c1"># msec</span>
    <span class="n">stim_end</span> <span class="o">=</span> <span class="n">ton</span> <span class="o">+</span> <span class="n">dur</span>
    <span class="n">trace_end</span> <span class="o">=</span> <span class="n">stim_end</span> <span class="o">+</span> <span class="n">post</span>
    <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">trace_end</span> <span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="c1"># dt is in msec, so tvec is in milliseconds</span>
    <span class="n">ta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">aw</span> <span class="o">=</span> <span class="n">ta</span> <span class="o">*</span> <span class="n">alpha</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ta</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="n">alpha</span> <span class="c1"># alpha waveform time course</span>
    <span class="n">spt</span> <span class="o">=</span> <span class="p">[[]]</span><span class="o">*</span><span class="n">N</span> <span class="c1"># list of spike times</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="p">[[]]</span><span class="o">*</span><span class="n">N</span> <span class="c1"># waveform</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span> <span class="c1"># for each</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sptime</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">qe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nsp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spont</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="mf">1e6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="o">/</span><span class="n">spont</span> <span class="c1"># q is in msec (spont in spikes/second)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">ton</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spont</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">ton</span>
                    <span class="k">continue</span>
                <span class="n">ti</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">spont</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">))</span> <span class="c1"># convert to msec</span>
                <span class="k">if</span> <span class="n">ti</span> <span class="o">&lt;</span> <span class="n">deadtime</span><span class="p">:</span> <span class="c1"># delete intervals less than deadtime</span>
                    <span class="k">continue</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">ti</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">ton</span><span class="p">:</span> <span class="c1"># if the interval would step us to the stimulus onset</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">ton</span> <span class="c1"># then set to to the stimulus onset</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">ton</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">stim_end</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">ton</span><span class="p">:</span>
                    <span class="n">rise</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">ton</span><span class="p">)</span><span class="o">/</span><span class="n">trise</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rise</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">ra</span> <span class="o">=</span> <span class="n">rr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">ton</span><span class="p">)</span><span class="o">/</span><span class="n">taur</span><span class="p">)</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">rst</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">ton</span><span class="p">)</span><span class="o">/</span><span class="n">taust</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">rise</span><span class="o">*</span><span class="p">(</span><span class="n">ra</span><span class="o">+</span><span class="n">rs</span><span class="o">+</span><span class="n">rss</span><span class="p">)</span>
                <span class="n">ti</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="n">spont</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="c1"># random.negexp(1000/q)</span>
                <span class="k">if</span> <span class="n">ti</span> <span class="o">&lt;</span> <span class="n">deadtime</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">ti</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">stim_end</span><span class="p">:</span> <span class="c1"># only include interval if it falls inside window</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">stim_end</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">stim_end</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">trace_end</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spont</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">trace_end</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">qe</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># have not calculated the new qe at end of stimulus</span>
                    <span class="n">rise</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">stim_end</span><span class="o">-</span><span class="n">ton</span><span class="p">)</span><span class="o">/</span><span class="n">trise</span><span class="p">)</span>
                    <span class="n">ra</span> <span class="o">=</span> <span class="n">rr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">stim_end</span><span class="o">-</span><span class="n">ton</span><span class="p">)</span><span class="o">/</span><span class="n">taur</span><span class="p">)</span>
                    <span class="n">rs</span> <span class="o">=</span> <span class="n">rst</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">stim_end</span><span class="o">-</span><span class="n">ton</span><span class="p">)</span><span class="o">/</span><span class="n">taust</span><span class="p">)</span>
                    <span class="n">qe</span> <span class="o">=</span> <span class="n">rise</span><span class="o">*</span><span class="p">(</span><span class="n">ra</span><span class="o">+</span><span class="n">rs</span><span class="o">+</span><span class="n">rss</span><span class="p">)</span> <span class="c1"># calculate the rate at the end</span>
                <span class="n">fall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">stim_end</span><span class="p">)</span><span class="o">/</span><span class="n">tfall</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">qe</span> <span class="o">*</span> <span class="n">fall</span>
                <span class="n">ti</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="n">spont</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span> <span class="c1"># keeps rate from falling below spont rate</span>
                <span class="k">if</span> <span class="n">ti</span> <span class="o">&lt;</span> <span class="n">deadtime</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">ti</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">trace_end</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="c1"># now add the spike time to the list</span>
            <span class="k">if</span> <span class="n">nsp</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sptime</span> <span class="o">=</span> <span class="n">t</span>
                <span class="n">nsp</span> <span class="o">=</span> <span class="n">nsp</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sptime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sptime</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">nsp</span> <span class="o">=</span> <span class="n">nsp</span><span class="o">+</span><span class="mi">1</span>
        <span class="c1"># end of for loop on i</span>
        <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wavej</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tvec</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sptime</span><span class="p">)):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sptime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">wavej</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavej</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">spt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sptime</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">makewave</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">wavej</span><span class="p">,</span> <span class="n">aw</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">aw</span><span class="p">))</span><span class="o">*</span><span class="n">amp</span>
            <span class="n">wave</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">npts</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">spt</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span></div>

<div class="viewcode-block" id="findspikes"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.findspikes">[docs]</a><span class="k">def</span> <span class="nf">findspikes</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; findspikes identifies the times of action potential in the trace v, with the</span>
<span class="sd">    times in t. An action potential is simply timed at the first point that exceeds</span>
<span class="sd">    the threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="c1"># np.where(v &gt; thresh) # np.array(v) &gt; thresh # find points above threshold</span>

<span class="c1">#    print (&#39;v: &#39;, v)</span>
    <span class="n">dsp</span> <span class="o">=</span> <span class="n">tm</span><span class="p">[</span><span class="n">s0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dsp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dsp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dsp</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dsp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># find first points of spikes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">dsp</span><span class="p">[</span><span class="n">sd</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="c1"># list of spike times.</span></div>

<div class="viewcode-block" id="measure"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.measure">[docs]</a><span class="k">def</span> <span class="nf">measure</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; return the mean and standard deviation of y in the window x0 to x1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xm</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_outside</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
    <span class="n">ym</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">xm</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ym</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ym</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ym</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ym</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ym</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;p2p&#39;</span><span class="p">:</span> <span class="c1"># peak to peak</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">ym</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span></div>

<div class="viewcode-block" id="mask"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.mask">[docs]</a><span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xm</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
    <span class="n">xmask</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_outside</span><span class="p">(</span><span class="n">xm</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
    <span class="n">xnew</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">xmask</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">xnew</span><span class="o">.</span><span class="n">compressed</span><span class="p">())</span></div>

<div class="viewcode-block" id="vector_strength"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.vector_strength">[docs]</a><span class="k">def</span> <span class="nf">vector_strength</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate vector strength and related parameters from a spike train, for the specified frequency</span>
<span class="sd">    :param spikes: Spike train, in msec.</span>
<span class="sd">    :param freq: Stimulus frequency in Hz</span>
<span class="sd">    :return: a dictionary containing:</span>
<span class="sd">    </span>
<span class="sd">        r: vector strength</span>
<span class="sd">        n: number of spikes</span>
<span class="sd">        R: Rayleigh coefficient</span>
<span class="sd">        p: p value (is distribution not flat?)</span>
<span class="sd">        ph: the circularized spike train over period of the stimulus freq, freq, in radians</span>
<span class="sd">        d: the &quot;dispersion&quot; computed according to Ashida et al., 2010, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">per</span> <span class="o">=</span> <span class="mf">1e3</span><span class="o">/</span><span class="n">freq</span> <span class="c1"># convert from Hz to period in msec</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">per</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="c1"># convert to radians within a cycle</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># standard vector strength computation</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="n">vs</span>  <span class="c1"># Raleigh coefficient</span>
    <span class="n">Rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="o">*</span><span class="n">vs</span><span class="o">*</span><span class="n">vs</span><span class="p">)</span>  <span class="c1"># p value for n &gt; 50 (see Ashida et al. 2010).</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">vs</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="p">)</span>
    <span class="k">return</span><span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">vs</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">Rp</span><span class="p">,</span> <span class="s1">&#39;ph&#39;</span><span class="p">:</span> <span class="n">ph</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">}</span></div>

<div class="viewcode-block" id="isi_cv2"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.isi_cv2">[docs]</a><span class="k">def</span> <span class="nf">isi_cv2</span><span class="p">(</span><span class="n">splist</span><span class="p">,</span> <span class="n">binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">tgrace</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; compute the cv and regularity according to Young et al., J. Neurophys, 60: 1, 1988.</span>
<span class="sd">        Analysis is limited to isi&#39;s starting at or after t0 but before t1, and ending completely</span>
<span class="sd">        before t1 + tgrace(to avoid end effects). t1 should correspond to the</span>
<span class="sd">        the end of the stimulus</span>
<span class="sd">        VERSION using dictionary for cvisi</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cvisit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">binwidth</span><span class="p">)</span> <span class="c1"># build time bins</span>
    <span class="n">cvisi</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># isi is dictionary, since each bin may have different length</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">splist</span><span class="p">)):</span> <span class="c1"># for all the traces</span>
        <span class="n">isit</span> <span class="o">=</span> <span class="n">splist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># get the spike times for this trial [1:-1]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isit</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># need 2 spikes to get an interval</span>
            <span class="k">continue</span>
        <span class="n">isib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">isit</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">binwidth</span><span class="p">)</span> <span class="c1"># discreetize</span>
        <span class="n">isii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">splist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># isis.</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">isib</span><span class="p">)):</span> <span class="c1"># loop over possible start time bins</span>
            <span class="k">if</span> <span class="n">isit</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t0</span> <span class="ow">or</span> <span class="n">isit</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t1</span> <span class="ow">or</span> <span class="n">isit</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="o">+</span><span class="n">tgrace</span><span class="p">:</span> <span class="c1"># start time and interval in the window</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">isib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cvisi</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;spike in bin: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">isib</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">cvisi</span><span class="p">[</span><span class="n">isib</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvisi</span><span class="p">[</span><span class="n">isib</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">isii</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="c1"># and add the isi in that bin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cvisi</span><span class="p">[</span><span class="n">isib</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">isii</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>	<span class="c1"># create it</span>
    <span class="n">cvm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="c1"># set up numpy arrays for mean, std and time for cv analysis</span>
    <span class="n">cvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">cvt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cvisi</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># for each entry (possible bin)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">cvisi</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span>
        <span class="nb">print</span> <span class="n">c</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># require 3 spikes in a bin for statistics</span>
            <span class="n">cvm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">cvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">cvt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvt</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">binwidth</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cvisit</span><span class="p">,</span> <span class="n">cvisi</span><span class="p">,</span> <span class="n">cvt</span><span class="p">,</span> <span class="n">cvm</span><span class="p">,</span> <span class="n">cvs</span><span class="p">)</span></div>

<div class="viewcode-block" id="isi_cv"><a class="viewcode-back" href="../../../util.html#cnmodel.util.pynrnutilities.isi_cv">[docs]</a><span class="k">def</span> <span class="nf">isi_cv</span><span class="p">(</span><span class="n">splist</span><span class="p">,</span> <span class="n">binwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">tgrace</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; compute the cv and regularity according to Young et al., J. Neurophys, 60: 1, 1988.</span>
<span class="sd">        Analysis is limited to isi&#39;s starting at or after t0 but before t1, and ending completely</span>
<span class="sd">        before t1 + tgrace(to avoid end effects). t1 should correspond to the</span>
<span class="sd">        the end of the stimulus</span>
<span class="sd">        Version using a list of numpy arrays for cvisi</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cvisit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">binwidth</span><span class="p">)</span> <span class="c1"># build time bins</span>
    <span class="n">cvisi</span> <span class="o">=</span> <span class="p">[[]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cvisit</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">splist</span><span class="p">)):</span> <span class="c1"># for all the traces</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># need at least 2 spikes</span>
            <span class="k">continue</span>
        <span class="n">isib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">splist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">binwidth</span><span class="p">)</span> <span class="c1"># begining spike times for each interval</span>
        <span class="n">isii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">splist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># associated intervals</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">isib</span><span class="p">)):</span> <span class="c1"># loop over spikes</span>
            <span class="k">if</span> <span class="n">splist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t0</span> <span class="ow">or</span> <span class="n">splist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t1</span> <span class="ow">or</span> <span class="n">splist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t1</span><span class="o">+</span><span class="n">tgrace</span><span class="p">:</span> <span class="c1"># start time and interval in the window</span>
                <span class="k">continue</span>
            <span class="n">cvisi</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">isib</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvisi</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">isib</span><span class="p">[</span><span class="n">j</span><span class="p">])],</span> <span class="n">isii</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="c1"># and add the isi in that bin</span>
    <span class="n">cvm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="c1"># set up numpy arrays for mean, std and time for cv analysis</span>
    <span class="n">cvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">cvt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cvisi</span><span class="p">)):</span> <span class="c1"># for each entry (possible bin)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cvisi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># require 3 spikes in a bin for statistics</span>
            <span class="n">cvm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">cvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">cvt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvt</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">binwidth</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cvisit</span><span class="p">,</span> <span class="n">cvisi</span><span class="p">,</span> <span class="n">cvt</span><span class="p">,</span> <span class="n">cvm</span><span class="p">,</span> <span class="n">cvs</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;isicv&#39;</span>

    <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;isicv&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; this test is not perfect. Given an ISI, we calculate spike times</span>
<span class="sd">        by drawing from a normal distribution whose standard deviation varies</span>
<span class="sd">        with time, from 0 (regular) to 1 (irregular). As coded, the standard</span>
<span class="sd">        deviation never reaches the target value because spikes fall before or</span>
<span class="sd">        after previous spikes (thus reducing the stdev). Nonetheless, this shows</span>
<span class="sd">        that the CV calculation works correctly. &quot;&quot;&quot;</span>
        <span class="n">nreps</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="c1"># cv will be 0 for first 50 msec, 0.5 for next 50 msec, and 1 for next 50 msec</span>
        <span class="n">d</span><span class="o">=</span><span class="p">[[]]</span><span class="o">*</span><span class="n">nreps</span>
        <span class="n">isi</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c1"># mean isi</span>
<span class="c1"># we create 100 msec of data where the CV goes from 0 to 1</span>
        <span class="n">maxt</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nreps</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">maxt</span><span class="o">/</span><span class="n">isi</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">isi</span>
                <span class="n">sd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">isi</span>
                <span class="k">if</span> <span class="n">sd</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="c1"># add more intervals at the end</span>
                <span class="n">te</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">isi</span>
                <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">te</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="c1">#			print d[i]</span>
<span class="c1">#			print diff(d[i])</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)):</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)]</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>

        <span class="p">(</span><span class="n">cvisit</span><span class="p">,</span> <span class="n">cvisi</span><span class="p">,</span> <span class="n">cvt</span><span class="p">,</span> <span class="n">cvm</span><span class="p">,</span> <span class="n">cvs</span><span class="p">)</span> <span class="o">=</span> <span class="n">isi_cv</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">binwidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tgrace</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cvt</span><span class="p">)</span>
        <span class="n">cvt</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">cvs</span> <span class="o">=</span> <span class="n">cvs</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">cvm</span> <span class="o">=</span> <span class="n">cvm</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cvt</span><span class="p">,</span> <span class="n">cvm</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cvt</span><span class="p">,</span> <span class="n">cvs</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cvt</span><span class="p">,</span> <span class="n">cvs</span><span class="o">/</span><span class="n">cvm</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;measure&#39;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">i is : </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">20</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">20</span>
            <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">=</span> <span class="n">measure</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;mean: </span><span class="si">%f</span><span class="s1">   std: </span><span class="si">%f</span><span class="s1"> [0, 20]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
            <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">=</span> <span class="n">measure</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;max: </span><span class="si">%f</span><span class="s1">   std: </span><span class="si">%f</span><span class="s1"> [0, 20]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
            <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">=</span> <span class="n">measure</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;min: </span><span class="si">%f</span><span class="s1">   std: </span><span class="si">%f</span><span class="s1"> [0, 20]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
            <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">=</span> <span class="n">measure</span><span class="p">(</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;median: </span><span class="si">%f</span><span class="s1">   std: </span><span class="si">%f</span><span class="s1"> [0, 20]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
            <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">=</span> <span class="n">measure</span><span class="p">(</span><span class="s1">&#39;p2p&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;peak to peak: </span><span class="si">%f</span><span class="s1">   std: </span><span class="si">%f</span><span class="s1"> [0, 20]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;an_syn&#39;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">an_syn</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">spont</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">driven</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">makewave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)]</span>

        <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pl</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)):</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">hold</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">(</span><span class="n">cvisit</span><span class="p">,</span> <span class="n">cvisi</span><span class="p">,</span> <span class="n">cvt</span><span class="p">,</span> <span class="n">cvm</span><span class="p">,</span> <span class="n">cvs</span><span class="p">)</span> <span class="o">=</span> <span class="n">isi_cv</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cvt</span><span class="p">)</span>
        <span class="n">cvt</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">cvs</span> <span class="o">=</span> <span class="n">cvs</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">cvm</span> <span class="o">=</span> <span class="n">cvm</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cvt</span><span class="p">,</span> <span class="n">cvs</span><span class="o">/</span><span class="n">cvm</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;syns&#39;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">syns</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">makewave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)]</span>

        <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pl</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>

        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">hold</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">(</span><span class="n">cvisit</span><span class="p">,</span> <span class="n">cvisi</span><span class="p">,</span> <span class="n">cvt</span><span class="p">,</span> <span class="n">cvm</span><span class="p">,</span> <span class="n">cvs</span><span class="p">)</span> <span class="o">=</span> <span class="n">isi_cv</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cvt</span><span class="p">)</span>
        <span class="n">cvt</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">cvs</span> <span class="o">=</span> <span class="n">cvs</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">cvm</span> <span class="o">=</span> <span class="n">cvm</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cvt</span><span class="p">,</span> <span class="n">cvs</span><span class="o">/</span><span class="n">cvm</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CNModel 0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, 2018, Paul B. Manis and Luke Campagnola.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.2.
    </div>
  </body>
</html>